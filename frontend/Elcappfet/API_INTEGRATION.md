# API Integration Documentation

## Overview

This document describes the integration between the Elcappfet React Native frontend and the Python FastAPI backend. The integration enables the mobile app to fetch real menu data from the Eldora restaurant API.

## Architecture

### Data Flow

```
User Action â†’ useMenu Hook â†’ API Service â†’ Backend FastAPI â†’ Eldora Website
                â†“                                â†“
         AsyncStorage Cache â† Data Transform â† JSON Response
                â†“
           React Components
```

### Component Structure

```
frontend/Elcappfet/
â”œâ”€â”€ .env                          # Environment configuration
â”œâ”€â”€ config/
â”‚   â””â”€â”€ environment.ts            # Environment variables manager
â”œâ”€â”€ types/
â”‚   â””â”€â”€ menu.ts                   # TypeScript interfaces
â”œâ”€â”€ services/
â”‚   â””â”€â”€ api.ts                    # HTTP client for backend
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ constants.ts              # App constants
â”‚   â””â”€â”€ dataTransform.ts          # Data transformation utilities
â”œâ”€â”€ hooks/
â”‚   â””â”€â”€ useMenu.ts                # Custom hook for menu state
â””â”€â”€ components/
    â”œâ”€â”€ LoadingState.tsx          # Loading skeleton screens
    â”œâ”€â”€ ErrorState.tsx            # Error display component
    â”œâ”€â”€ MenuCard.tsx              # Menu item card (updated)
    â”œâ”€â”€ DayFilter.tsx             # Day selector (updated)
    â””â”€â”€ index.tsx                 # Main screen (updated)
```

## Backend API Endpoints

### Base URL

- **Development**: `http://localhost:8000`
- **Production**: Configure in `.env` file

### Available Endpoints

#### 1. Weekly Menu

```http
GET /menus/weekly
```

**Response:**

```json
{
  "success": true,
  "data": {
    "semaine": "Du 6 au 10 Octobre",
    "jours": {
      "lundi": {
        "bistro": {
          "type": "Bistro",
          "contenu": "Menu description",
          "prix": "CHF 14.50",
          "disponible": true
        },
        "vitality": {
          "type": "Vitality",
          "contenu": "Menu description",
          "prix": "CHF 14.50",
          "disponible": true
        }
      }
    }
  },
  "metadata": {
    "source_url": "https://app2.eldora.ch/totem/matin?NumEts=9677",
    "parsed_at": "2024-01-01T12:00:00",
    "total_jours": 5
  }
}
```

#### 2. Menu Images

```http
GET /images/menu/{type}/{description}
```

**Parameters:**

- `type`: Menu type ("Bistro" or "Vitality")
- `description`: Menu description (URL encoded)

**Response:** PNG image (generated by Google GenAI)

**Example:**

```
GET /images/menu/Bistro/Korma%20de%20poulet%20Riz%20aux%20%C3%A9pices
```

## Frontend Implementation

### 1. Environment Configuration

**File:** `.env`

```bash
EXPO_PUBLIC_API_BASE_URL=http://localhost:8000
EXPO_PUBLIC_API_TIMEOUT=30000
EXPO_PUBLIC_CACHE_DURATION=7200000  # 2 hours
```

### 2. API Service

**File:** `services/api.ts`

```typescript
import apiService from "../services/api";

// Fetch weekly menu
const response = await apiService.fetchWeeklyMenu();

// Get image URL
const imageUrl = apiService.getImageUrl("Bistro", "Menu description");

// Check backend health
const isHealthy = await apiService.checkHealth();
```

**Features:**

- Timeout handling (30s default)
- Error handling with custom error types
- Automatic JSON parsing
- Development logging

### 3. Data Transformation

**File:** `utils/dataTransform.ts`

Transforms backend French data to frontend English format:

```typescript
// Backend format (French)
{
  jour: "lundi",
  bistro: {
    type: "Bistro",
    contenu: "Korma de poulet Riz aux Ã©pices",
    prix: "CHF 14.50"
  }
}

// Frontend format (English)
{
  id: "bistro_0_1234567890",
  name: "Korma de poulet",
  description: "Korma de poulet Riz aux Ã©pices",
  price: 14.50,
  category: "Bistro",
  imageUrl: "http://localhost:8000/images/menu/Bistro/...",
  dietaryTags: ["High Protein"]
}
```

**Transformation Steps:**

1. Map French day names to indices (lundi â†’ 0, mardi â†’ 1, etc.)
2. Extract menu name from first N words
3. Parse CHF price string to number
4. Generate image URL
5. Detect dietary tags from description

### 4. Custom Hook: useMenu

**File:** `hooks/useMenu.ts`

```typescript
import { useMenu } from "../hooks/useMenu";

function MyComponent() {
  const { loading, error, data, weekInfo, refreshing, refetch } =
    useMenu(selectedDay);

  // data: MenuItem[] | null
  // loading: boolean
  // error: string | null
  // refetch: () => Promise<void>
}
```

**Features:**

- Automatic data fetching on mount
- Two-level caching (memory + AsyncStorage)
- Cache invalidation after 2 hours
- Fallback to cached data on error
- Pull-to-refresh support
- Automatic cleanup on unmount

**Cache Strategy:**

```typescript
// Level 1: In-memory cache (fastest)
weeklyCache.current.get(dayIndex);

// Level 2: AsyncStorage (persistent)
await AsyncStorage.getItem("menu_cache_0");

// Level 3: API fetch (slowest)
await apiService.fetchWeeklyMenu();
```

### 5. UI Components

#### LoadingState

Displays skeleton screens while data loads:

```typescript
<LoadingState count={2} />
```

#### ErrorState

Shows error message with retry button:

```typescript
<ErrorState message="Unable to connect to server" onRetry={refetch} />
```

#### Pull-to-Refresh

```typescript
<ScrollView
  refreshControl={
    <RefreshControl
      refreshing={refreshing}
      onRefresh={refetch}
      tintColor="#fafafa"
    />
  }
>
```

## Day Mapping

### Backend (French) â†’ Frontend (English)

| French   | English   | Index |
| -------- | --------- | ----- |
| lundi    | Monday    | 0     |
| mardi    | Tuesday   | 1     |
| mercredi | Wednesday | 2     |
| jeudi    | Thursday  | 3     |
| vendredi | Friday    | 4     |

**Note:** Only weekdays (Monday-Friday) are displayed in the UI. The backend does not provide weekend menus.

## Error Handling

### Error Types

1. **Network Error** (No internet connection)

   ```
   "Unable to connect to the server. Please check your internet connection."
   ```

2. **Server Error** (5xx responses)

   ```
   "Server is currently unavailable. Please try again later."
   ```

3. **Timeout Error** (Request > 30s)

   ```
   "Request timed out. Please try again."
   ```

4. **Parse Error** (Invalid JSON)
   ```
   "Unable to process menu data. Please try again."
   ```

### Error Recovery

1. **With Cached Data**: Show cached data with warning banner
2. **Without Cached Data**: Show full error screen with retry button
3. **Pull-to-Refresh**: Always available to retry

## Performance Optimizations

### 1. Caching Strategy

- **Memory Cache**: Instant access for previously loaded days
- **AsyncStorage**: Persistent cache survives app restarts
- **Cache Duration**: 2 hours before invalidation

### 2. Image Loading

- **Lazy Loading**: Images load as MenuCards render
- **Placeholder**: Gray background while loading
- **On-Demand Generation**: Backend generates images on first request

### 3. Component Optimization

- **React.memo**: MenuCard wrapped for performance
- **Key Props**: Unique IDs for efficient list rendering
- **Skeleton Screens**: Perceived performance during loading

## Testing the Integration

### Prerequisites

1. **Backend Running**:

   ```bash
   cd backend
   python menu_parser_server.py
   ```

   Backend should be accessible at `http://localhost:8000`

2. **Frontend Running**:
   ```bash
   cd frontend/Elcappfet
   npm start
   ```

### Test Scenarios

#### 1. Initial Load

```
Expected: Loading skeleton â†’ Menu data appears
Logs: "Fetching menu from API for day 0"
```

#### 2. Day Switch

```
Action: Tap different day in DayFilter
Expected: Loading skeleton â†’ New day's menu
Cache: Subsequent switches should be instant
```

#### 3. Pull-to-Refresh

```
Action: Pull down ScrollView
Expected: Refresh indicator â†’ Updated data
```

#### 4. Offline Mode

```
Action: Disable internet, reopen app
Expected: Cached menu displays with warning
```

#### 5. Backend Offline

```
Action: Stop backend server, try refresh
Expected: Error screen with retry button
Fallback: Cached data shown if available
```

#### 6. Image Loading

```
Expected: Images load progressively
First Load: May take 3-5s (AI generation)
Cached: Images load instantly from backend cache
```

### Debugging

#### Enable Development Logs

Check console for:

```
âœ… Environment configured
ðŸ“¡ Fetching weekly menu from: http://localhost:8000/menus/weekly
âœ… Weekly menu fetched successfully
ðŸ’¾ Saved menu to cache for day 0
```

#### Clear Cache

```typescript
import { useMenu } from "../hooks/useMenu";

const { clearCache } = useMenu(0);
await clearCache(); // Clears all cached data
```

#### Check Backend Health

```typescript
import apiService from "../services/api";

const isHealthy = await apiService.checkHealth();
console.log("Backend health:", isHealthy);
```

## Common Issues

### 1. "Unable to connect to server"

**Cause**: Backend not running or wrong URL

**Solution**:

- Verify backend is running: `curl http://localhost:8000/health`
- Check `.env` file has correct `EXPO_PUBLIC_API_BASE_URL`
- For Android emulator, use `10.0.2.2` instead of `localhost`
- For iOS simulator, `localhost` should work

### 2. "No menu items available"

**Cause**: Backend returned empty data for selected day

**Solution**:

- Check backend response: `curl http://localhost:8000/menus/weekly`
- Verify Eldora website is accessible
- Check backend logs for parsing errors

### 3. Images not loading

**Cause**: Image generation service unavailable

**Solution**:

- Verify Google GenAI API key in backend `.env`
- Check backend logs for image generation errors
- Images may take 3-5s on first generation

### 4. Cache not clearing

**Cause**: AsyncStorage issues

**Solution**:

```typescript
import AsyncStorage from "@react-native-async-storage/async-storage";

// Clear all AsyncStorage
await AsyncStorage.clear();
```

## API Configuration for Different Environments

### Development (Local)

```bash
EXPO_PUBLIC_API_BASE_URL=http://localhost:8000
```

### Android Emulator

```bash
EXPO_PUBLIC_API_BASE_URL=http://10.0.2.2:8000
```

### iOS Simulator

```bash
EXPO_PUBLIC_API_BASE_URL=http://localhost:8000
```

### Physical Device (Same Network)

```bash
EXPO_PUBLIC_API_BASE_URL=http://192.168.1.X:8000
# Replace X with your computer's IP address
```

### Production

```bash
EXPO_PUBLIC_API_BASE_URL=https://api.yourdomain.com
```

## Security Considerations

1. **CORS**: Backend configured with `allow_origins=["*"]` for development
2. **No Authentication**: Current implementation has no auth (public menu data)
3. **Rate Limiting**: Consider adding rate limiting in production
4. **HTTPS**: Use HTTPS in production environments

## Future Enhancements

1. **Offline-First**: Implement full offline support with background sync
2. **Push Notifications**: Notify users when new menus are available
3. **Favorites**: Allow users to favorite menu items
4. **Ratings**: Let users rate menu items
5. **Image Caching**: Implement advanced image caching strategy
6. **Analytics**: Track popular menu items and user behavior

## Support

For issues or questions:

1. Check console logs for error details
2. Verify backend is running and accessible
3. Clear cache and retry
4. Check this documentation for common solutions

## Version History

- **v1.0.0** (2024): Initial integration with backend API
  - Weekly menu fetching
  - Image generation support
  - Two-level caching
  - Pull-to-refresh
  - Error handling and recovery
